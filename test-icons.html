<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾æ ‡åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 {
            color: #333;
            margin-top: 0;
        }
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
            margin-bottom: 10px;
        }
        .icon-btn {
            width: 48px;
            height: 48px;
            border: none;
            border-radius: 12px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #F0F2F6;
            transition: all 0.2s;
        }
        .icon-btn:hover {
            background: #E9EDF2;
        }
        .icon-btn.selected {
            background: linear-gradient(135deg, #FF6B81, #FF9FF3);
            box-shadow: 0 4px 12px rgba(255, 107, 129, 0.3);
            transform: scale(1.1);
        }
        .add-btn {
            width: 48px;
            height: 48px;
            border: 2px dashed #636E72;
            border-radius: 12px;
            background: #F0F2F6;
            font-size: 24px;
            color: #636E72;
            cursor: pointer;
            transition: all 0.2s;
        }
        .add-btn:hover {
            background: #E9EDF2;
            border-color: #8B5CF6;
        }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .storage-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ¨ å›¾æ ‡ä¼˜åŒ–ä¸è‡ªå®šä¹‰åŠŸèƒ½æµ‹è¯•</h1>

    <!-- ä»»åŠ¡ 6: å›¾æ ‡ä¼˜åŒ– -->
    <div class="test-section">
        <h2>ä»»åŠ¡ 6: å›¾æ ‡ä¼˜åŒ–</h2>
        <p><strong>ä¿ç•™çš„å›¾æ ‡ (15 ä¸ª):</strong></p>
        <div class="icon-grid" id="presetIcons"></div>
        <p style="color: #666; font-size: 12px;">âœ… å¸ƒå±€æ”¹ä¸º 6 åˆ—ï¼ŒæŒ‰é’®å¢å¤§åˆ° 48x48ï¼Œé—´è· 12px</p>
    </div>

    <!-- ä»»åŠ¡ 7: è‡ªå®šä¹‰å›¾æ ‡ä¸Šä¼  -->
    <div class="test-section">
        <h2>ä»»åŠ¡ 7: è‡ªå®šä¹‰å›¾æ ‡ä¸Šä¼ </h2>
        <div class="icon-grid" id="customIcons"></div>
        <button class="add-btn" onclick="handleImageUpload()">+</button>
        <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
        <div id="uploadStatus" class="status info">ç‚¹å‡» "+" ä¸Šä¼ è‡ªå®šä¹‰å›¾æ ‡ (æœ€å¤§ 50KB, 128x128)</div>
    </div>

    <!-- ä»»åŠ¡ 8: å›¾æ ‡å­˜å‚¨ç®¡ç† -->
    <div class="test-section">
        <h2>ä»»åŠ¡ 8: å›¾æ ‡å­˜å‚¨ç®¡ç†</h2>
        <button onclick="displayStorage()" style="padding: 8px 16px; background: #8B5CF6; color: white; border: none; border-radius: 8px; cursor: pointer; margin-bottom: 10px;">æ˜¾ç¤º localStorage</button>
        <button onclick="clearStorage()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; margin-left: 10px;">æ¸…ç©ºè‡ªå®šä¹‰å›¾æ ‡</button>
        <div id="storageDisplay" class="storage-display"></div>
    </div>

    <script>
        // é¢„è®¾å›¾æ ‡ (ç²¾ç®€å)
        const EMOJI_OPTIONS = [
            'ğŸœ', 'â˜•', 'ğŸ•', 'ğŸ”', 'ğŸ£', 'ğŸ¥',
            'ğŸš•', 'ğŸ«', 'ğŸ›ï¸',
            'ğŸ’Š', 'ğŸ', 'ğŸ®',
            'ğŸª', 'â›½', 'ğŸ“'
        ];

        // åˆå§‹åŒ–é¢„è®¾å›¾æ ‡æ˜¾ç¤º
        function initPresetIcons() {
            const container = document.getElementById('presetIcons');
            EMOJI_OPTIONS.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'icon-btn';
                btn.textContent = emoji;
                btn.onclick = () => {
                    document.querySelectorAll('.icon-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                };
                container.appendChild(btn);
            });
        }

        // åŠ è½½è‡ªå®šä¹‰å›¾æ ‡
        function loadCustomIcons() {
            try {
                const data = localStorage.getItem('customIcons');
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error('åŠ è½½è‡ªå®šä¹‰å›¾æ ‡å¤±è´¥:', e);
                return [];
            }
        }

        // ä¿å­˜è‡ªå®šä¹‰å›¾æ ‡
        function saveCustomIcons(icons) {
            try {
                localStorage.setItem('customIcons', JSON.stringify(icons));
                return true;
            } catch (e) {
                console.error('ä¿å­˜è‡ªå®šä¹‰å›¾æ ‡å¤±è´¥:', e);
                return false;
            }
        }

        // æ˜¾ç¤ºè‡ªå®šä¹‰å›¾æ ‡
        function displayCustomIcons() {
            const container = document.getElementById('customIcons');
            container.innerHTML = '';
            const icons = loadCustomIcons();

            icons.forEach(icon => {
                const btn = document.createElement('button');
                btn.className = 'icon-btn';
                btn.style.position = 'relative';
                btn.innerHTML = `<img src="${icon.data}" style="width: 32px; height: 32px; object-fit: cover; border-radius: 4px;">`;

                // å³é”®åˆ é™¤
                btn.oncontextmenu = (e) => {
                    e.preventDefault();
                    if (confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªè‡ªå®šä¹‰å›¾æ ‡?')) {
                        const updated = icons.filter(i => i.id !== icon.id);
                        if (saveCustomIcons(updated)) {
                            displayCustomIcons();
                            displayStorage();
                            showStatus('å›¾æ ‡å·²åˆ é™¤', 'success');
                        }
                    }
                };

                btn.onclick = () => {
                    document.querySelectorAll('.icon-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                };

                container.appendChild(btn);
            });
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload() {
            document.getElementById('fileInput').click();
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showStatus('âŒ è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }

            showStatus('â³ æ­£åœ¨å¤„ç†å›¾ç‰‡...', 'info');

            try {
                // 1. è¯»å–æ–‡ä»¶
                const bitmap = await createImageBitmap(file);

                // 2. è°ƒæ•´å°ºå¯¸ (æœ€å¤§ 128x128)
                const maxSize = 128;
                let width = bitmap.width;
                let height = bitmap.height;

                if (width > height) {
                    if (width > maxSize) {
                        height = (height * maxSize) / width;
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width = (width * maxSize) / height;
                        height = maxSize;
                    }
                }

                // 3. ç»˜åˆ¶åˆ° canvas
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(bitmap, 0, 0, width, height);

                // 4. å‹ç¼©ä¸º JPEG (è´¨é‡ 0.7)
                const dataUrl = canvas.toDataURL('image/jpeg', 0.7);

                // 5. æ£€æŸ¥å¤§å° (æœ€å¤§ 50KB)
                const sizeInKB = Math.round((dataUrl.length * 3) / 4 / 1024);
                if (sizeInKB > 50) {
                    showStatus(`âŒ å›¾ç‰‡è¿‡å¤§ (${sizeInKB}KB)ï¼Œè¯·é€‰æ‹©æ›´å°çš„å›¾ç‰‡ (æœ€å¤§ 50KB)`, 'error');
                    return;
                }

                // 6. æ£€æŸ¥æ•°é‡é™åˆ¶
                const existing = loadCustomIcons();
                if (existing.length >= 5) {
                    showStatus('âŒ æœ€å¤šåªèƒ½æ·»åŠ  5 ä¸ªè‡ªå®šä¹‰å›¾æ ‡', 'error');
                    return;
                }

                // 7. ä¿å­˜æ–°å›¾æ ‡
                const newIcon = {
                    id: Date.now().toString(),
                    data: dataUrl,
                    createdAt: new Date().toISOString()
                };

                const updated = [...existing, newIcon];
                if (saveCustomIcons(updated)) {
                    displayCustomIcons();
                    displayStorage();
                    showStatus(`âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ! (${sizeInKB}KB)`, 'success');
                }

            } catch (e) {
                console.error('å›¾ç‰‡å¤„ç†å¤±è´¥:', e);
                showStatus('âŒ å›¾ç‰‡å¤„ç†å¤±è´¥: ' + e.message, 'error');
            }

            // é‡ç½® input
            event.target.value = '';
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            const status = document.getElementById('uploadStatus');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // æ˜¾ç¤º localStorage å†…å®¹
        function displayStorage() {
            const icons = loadCustomIcons();
            const display = document.getElementById('storageDisplay');
            display.innerHTML = `
                <strong>è‡ªå®šä¹‰å›¾æ ‡æ•°é‡:</strong> ${icons.length}/5<br>
                <strong>æ€»å¤§å°:</strong> ${calculateTotalSize(icons)} KB<br>
                <strong>è¯¦ç»†æ•°æ®:</strong><br>
                ${JSON.stringify(icons, null, 2).substring(0, 500)}...
            `;
        }

        // è®¡ç®—æ€»å¤§å°
        function calculateTotalSize(icons) {
            return icons.reduce((total, icon) => {
                return total + Math.round((icon.data.length * 3) / 4 / 1024);
            }, 0);
        }

        // æ¸…ç©ºè‡ªå®šä¹‰å›¾æ ‡
        function clearStorage() {
            if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰è‡ªå®šä¹‰å›¾æ ‡?')) {
                localStorage.removeItem('customIcons');
                displayCustomIcons();
                displayStorage();
                showStatus('âœ… è‡ªå®šä¹‰å›¾æ ‡å·²æ¸…ç©º', 'success');
            }
        }

        // åˆå§‹åŒ–
        initPresetIcons();
        displayCustomIcons();
        displayStorage();
    </script>
</body>
</html>
